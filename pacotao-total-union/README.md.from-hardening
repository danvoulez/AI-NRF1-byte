# Pacot√£o HARDENING üîê

Este pacote aplica **endurecimento** ao que j√° entregamos:
- **Valida√ß√£o por JSON Schema** dos manifests
- **Whitelist de capabilities** (nega passos desconhecidos)
- **Limites e sanitiza√ß√£o de entradas** no CLI (`ubl` ‚Üí `modules.rs`)
- **`cap-runtime` fortalecido**: allowlist de executores, HMAC opcional, idempot√™ncia (CID do plano), nonce/exp
- **Schema**: `configs/schema/manifest.v1.json`

## Como aplicar

1. Copie os arquivos para as mesmas localiza√ß√µes no seu repo:
   - `tools/ubl-cli/src/modules.rs` (substitui)
   - `modules/cap-runtime/**` (substitui/sobe de vers√£o)
   - `configs/schema/manifest.v1.json` (novo)
2. Aplique o patch de depend√™ncias no `ubl-cli`:
   - `patches/tools_ubl_cli_Cargo_toml.patch` ‚Üí `tools/ubl-cli/Cargo.toml`
3. Build:
```bash
cargo build -p ubl-cli -p cap-runtime
```

## Notas de seguran√ßa
- Manifests maiores que **256KB** s√£o rejeitados.
- Caminhos com **`..`** ou absolutos em `--manifest` s√£o rejeitados.
- `use` fora da **whitelist** ‚Üí rejeitado.
- Para `tdln.*` e `llm.*`, `outputs.fields` deve conter `receipt_cid` e `url_rica`.
- `cap-runtime` n√£o aceita **blobs inline**; apenas **CIDs** como inputs.

## Pr√≥ximos passos sugeridos
- Adicionar **AppendReceipt idempotente** (plan_cid+trace_id) no executor.
- Habilitar **CSP** e token TTL na **URL rica**.
- Providers LLM com **cache/timeout/metrics** e tabela de custos pinada.
