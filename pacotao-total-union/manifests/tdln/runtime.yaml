version: 1
name: tdln-runtime
backend: { mode: in-process }
pipeline:
  - use: cap-intake
    with: { map: { data: "@inputs.sourceData", code: "@inputs.userCode" } }
  - when: ${inputs.userCode != null}
    use: cap-runtime
    with:
      executor: "wasmtime"
      limits: { cpu_ms: 1500, memory_mb: 512, wall_ms: 2500 }
      code_input: "code"
      data_input: "data"
      webhook_binding: "EXECUTOR_URL"
  - use: cap-policy
    with: { refs: [{ cid: "bafyPolicy..." }], fail_on_violation: true }
  - use: cap-enrich
    with: { produce: [{ kind: html, template: "receipts/report.html" }, { kind: json }] }
  - use: cap-transport
    with: { publish: ["receipt","artifacts"] }
outputs: { format: "json", fields: ["decision","receipt_cid","url_rica","artifacts"] }
