name: nightly-lab512

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # 03:00 UTC

jobs:
  nightly:
    runs-on: [self-hosted, lab512]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Skip if already latest
        id: skip
        shell: bash
        run: |
          set -euo pipefail
          BASE_DIR="${LAB512_ARTIFACTS_DIR:-/opt/lab512/artifacts/nightly}"
          LATEST="${BASE_DIR}/latest"
          if [[ -L "${LATEST}" ]]; then
            TARGET="$(readlink "${LATEST}" || true)"
            if [[ "$(basename "${TARGET}")" == "${GITHUB_SHA}" ]]; then
              echo "skip=true" >> "${GITHUB_OUTPUT}"
              echo "Already published: ${GITHUB_SHA} (latest -> ${TARGET})"
              exit 0
            fi
          fi
          echo "skip=false" >> "${GITHUB_OUTPUT}"

      - name: Check BASE (must be green)
        if: steps.skip.outputs.skip != 'true'
        run: make check-base

      - name: Build (release)
        if: steps.skip.outputs.skip != 'true'
        run: cargo build --release -p ai-nrf1 -p ubl-cli -p registry

      - name: Publish locally (nightly)
        if: steps.skip.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          SHA="${GITHUB_SHA}"
          BASE_DIR="${LAB512_ARTIFACTS_DIR:-/opt/lab512/artifacts/nightly}"
          OUT="${BASE_DIR}/${SHA}"
          mkdir -p "${OUT}"

          cp -f target/release/ai-nrf1 "${OUT}/ai-nrf1" || true
          cp -f target/release/ubl "${OUT}/ubl" || true
          cp -f target/release/registry "${OUT}/registry" || true

          ln -sfn "${OUT}" "${BASE_DIR}/latest"
          echo "Published to ${OUT} (latest -> ${BASE_DIR}/latest)"
