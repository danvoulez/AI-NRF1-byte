name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      - name: fmt
        run: cargo fmt --all -- --check
      - name: clippy (base)
        run: >
          cargo clippy
          -p nrf-core
          -p ai-nrf1
          -p ubl_json_view
          -p ubl_capsule
          --all-targets
          --all-features
          -- -D warnings
      - name: test (base)
        run: >
          cargo test
          -p nrf-core
          -p ai-nrf1
          -p ubl_json_view
          -p ubl_capsule
          --all-features
          --locked

  modules:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: modules
      - name: clippy (modules)
        run: >
          cargo clippy
          -p modules-core
          -p module-runner
          -p cap-intake
          -p cap-policy
          -p cap-permit
          -p cap-enrich
          -p cap-transport
          -p cap-llm
          --all-targets
          -- -D warnings
      - name: test (module-runner â€” 42 tests)
        run: cargo test -p module-runner --locked
      - name: build registry with modules
        run: cargo build -p registry --features modules --locked

  python-differential:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: python-differential
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build CLI (nrf1)
        run: cargo build -p nrf1-cli
      - name: Install Python deps
        run: python -m pip install -r tests/differential/requirements.txt
      - name: Differential tests (Rust CLI vs Python ref)
        env:
          PYTHONPATH: ${{ github.workspace }}/impl/python/nrf_core_ref
        run: |
          export PATH="${GITHUB_WORKSPACE}/target/debug:${PATH}"
          pytest -q tests/differential/test_diff_cli_vs_python.py

  fuzz-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: fuzz-smoke
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
      - name: Build fuzz targets
        working-directory: impl/rust/nrf-core/fuzz
        run: cargo fuzz build

  wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: wasm
      - name: Add wasm target
        run: rustup target add wasm32-unknown-unknown
      - name: Build WASM crates
        run: >
          cargo build
          -p ai-nrf1-wasm
          -p ubl-capsule-wasm
          --target wasm32-unknown-unknown

  wasm-node-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: wasm-node-smoke
      - name: Add wasm target
        run: rustup target add wasm32-unknown-unknown
      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
      - name: Build wasm-pack node packages
        run: bash tools/wasm/build_node_pkgs.sh
      - name: Node smoke (offline verify)
        run: node tests/wasm/node_smoke.cjs
