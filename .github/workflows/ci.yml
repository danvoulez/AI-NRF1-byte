name: ci

on:
  pull_request:
  push:
    branches: [ main ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  base:
    name: BASE (fmt + clippy + tests)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2

      - name: Format
        run: cargo fmt --all -- --check

      - name: Clippy (BASE crates)
        run: |
          cargo clippy \
            -p nrf-core -p ai-nrf1 -p ubl_json_view -p ubl_capsule \
            --all-targets --all-features -- -D warnings

      - name: Test (BASE only)
        run: |
          cargo test --locked \
            -p nrf-core -p ai-nrf1 -p ubl_json_view -p ubl_capsule

  modules:
    name: MODULES (clippy + tests + registry --features modules)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2

      - name: Clippy (modules)
        run: |
          cargo clippy \
            -p modules-core \
            -p module-runner \
            -p cap-intake \
            -p cap-policy \
            -p cap-permit \
            -p cap-enrich \
            -p cap-transport \
            -p cap-llm \
            --all-targets -- -D warnings

      - name: Test (modules)
        run: |
          cargo test --locked \
            -p modules-core \
            -p module-runner

      - name: Build registry (module routes enabled)
        run: cargo build -p registry --features modules --locked

  python-differential:
    name: Python â†” Rust (differential)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Build CLI
        run: cargo build --locked -p nrf1-cli

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: python -m pip install -r tests/differential/requirements.txt

      - name: Differential tests
        env:
          PYTHONPATH: ${{ github.workspace }}/impl/python/nrf_core_ref
        run: |
          export PATH="${GITHUB_WORKSPACE}/target/debug:${PATH}"
          pytest -q tests/differential/test_diff_cli_vs_python.py

  wasm:
    name: WASM (build + node smoke)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Add wasm target
        run: rustup target add wasm32-unknown-unknown

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0

      - name: Build wasm-pack node packages
        run: bash tools/wasm/build_node_pkgs.sh

      - name: Node smoke (offline verify)
        run: node tests/wasm/node_smoke.cjs

  fuzz-smoke:
    name: Fuzz (build only)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
      - name: Build fuzz targets
        working-directory: impl/rust/nrf-core/fuzz
        run: cargo fuzz build

  workspace-full:
    name: Workspace (sanity)
    runs-on: ubuntu-latest
    needs: [base, modules, python-differential, wasm]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build all (lockfile)
        run: cargo build --workspace --locked
      - name: Test all (lockfile)
        run: cargo test --workspace --locked

  collect-logs:
    name: Failure artifacts
    runs-on: ubuntu-latest
    needs: [base, modules, python-differential, wasm, fuzz-smoke, workspace-full]
    if: failure()
    steps:
      - uses: actions/checkout@v4
      - name: Collect logs
        run: |
          mkdir -p dist-logs
          find . -type f -name "*.log" -maxdepth 4 -print -exec cp -v {} dist-logs/ \; || true
      - uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: dist-logs
