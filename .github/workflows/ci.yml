name: ci

on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  base:
    name: BASE (fmt + clippy + tests)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Format
        run: cargo fmt --all -- --check

      - name: Clippy (BASE crates)
        run: |
          cargo clippy \
            -p nrf-core -p ai-nrf1 -p ubl_json_view -p ubl_capsule \
            --all-targets --all-features -- -D warnings

      - name: Test (BASE only)
        run: |
          cargo test --locked \
            -p nrf-core -p ai-nrf1 -p ubl_json_view -p ubl_capsule

  modules:
    name: MODULES (clippy + tests + registry --features modules)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Clippy (modules)
        run: |
          cargo clippy \
            -p modules-core \
            -p module-runner \
            -p cap-intake \
            -p cap-policy \
            -p cap-permit \
            -p cap-enrich \
            -p cap-transport \
            -p cap-llm \
            --all-targets -- -D warnings

      - name: Test (modules)
        run: |
          cargo test --locked \
            -p modules-core \
            -p module-runner

      - name: Build registry (module routes enabled)
        run: cargo build -p registry --features modules --locked

  python-differential:
    name: Python ↔ Rust (differential)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Build CLI
        run: cargo build --locked -p nrf1-cli

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: python -m pip install -r tests/differential/requirements.txt

      - name: Differential tests
        env:
          PYTHONPATH: ${{ github.workspace }}/impl/python/nrf_core_ref
        run: |
          export PATH="${GITHUB_WORKSPACE}/target/debug:${PATH}"
          pytest -q tests/differential/test_diff_cli_vs_python.py

  wasm:
    name: WASM (build + node smoke)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0

      - name: Build wasm-pack node packages
        run: bash tools/wasm/build_node_pkgs.sh

      - name: Node smoke (offline verify)
        run: node tests/wasm/node_smoke.cjs

  fuzz-smoke:
    name: Fuzz (build only)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: System deps (clang/llvm)
        run: sudo apt-get update && sudo apt-get install -y clang lld llvm-dev libclang-dev
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
      - name: Build fuzz targets
        working-directory: impl/rust/nrf-core/fuzz
        run: cargo fuzz build

  canon-guard:
    name: Canon regression guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Ghost prefix check (b64:/0x: as bytes encoding)"
        run: |
          # Canon 4: bytes must use {"$bytes":"<hex>"}, never "b64:" or "0x:" prefixes.
          # "b3:" is legitimate as a CID string format, so we only check b64:/0x:.
          HITS=$(grep -rn --include='*.rs' \
            -e '"b64:' -e '"0x:' \
            --exclude-dir=target \
            . \
            | grep -v '// Canon\|// legacy\|// old format\|#\[doc\|///\|//!\|is_just_a_string\|stays_string' \
            || true)
          if [ -n "$HITS" ]; then
            echo "::error::Ghost byte prefixes found in Rust source (Canon 4 violation):"
            echo "$HITS"
            exit 1
          fi
          echo "✓ No ghost byte prefixes found"

      - name: "No Value::Bytes from b3: prefix parsing"
        run: |
          # Ensure no code path converts "b3:..." strings into Value::Bytes.
          # The b3: prefix is a CID string, not a bytes encoding.
          HITS=$(grep -rn --include='*.rs' \
            -e 'starts_with("b3:").*Bytes\|starts_with("b64:").*Bytes\|starts_with("0x:").*Bytes' \
            --exclude-dir=target \
            . || true)
          if [ -n "$HITS" ]; then
            echo "::error::Prefix-to-Bytes conversion found (Canon 4 violation):"
            echo "$HITS"
            exit 1
          fi
          echo "✓ No prefix-to-Bytes conversions found"

      - name: "No float Value variants"
        run: |
          # Canon 2: NRF has no float type. Ensure nobody adds Value::Float or Value::F64.
          HITS=$(grep -rn --include='*.rs' \
            -e 'Value::Float' -e 'Value::F64' -e 'Value::F32' \
            --exclude-dir=target \
            . || true)
          if [ -n "$HITS" ]; then
            echo "::error::Float Value variant found (Canon 2 violation):"
            echo "$HITS"
            exit 1
          fi
          echo "✓ No float Value variants found"

  workspace-full:
    name: Workspace (sanity)
    runs-on: ubuntu-latest
    needs: [base, modules, python-differential, wasm]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Build all (lockfile)
        run: cargo build --workspace --locked
      - name: Test all (lockfile)
        run: cargo test --workspace --locked

  registry-integration:
    name: Registry (HTTP smoke)
    runs-on: ubuntu-latest
    needs: [modules]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Build registry (modules)
        run: cargo build -p registry --features modules --locked
      - name: Start registry
        run: |
          ./target/debug/registry &
          echo $! > registry.pid
          for i in $(seq 1 30); do
            curl -fsS http://127.0.0.1:8080/health && break
            sleep 1
          done
        env:
          PORT: "8080"
          RUST_LOG: "registry=info"
      - name: Probe endpoints
        run: |
          curl -fsS http://127.0.0.1:8080/health
          curl -fsS http://127.0.0.1:8080/healthz
          curl -fsS http://127.0.0.1:8080/readyz
          curl -fsS http://127.0.0.1:8080/version
      - name: Teardown
        if: always()
        run: kill $(cat registry.pid) || true

  collect-logs:
    name: Failure artifacts
    runs-on: ubuntu-latest
    needs: [base, modules, python-differential, wasm, fuzz-smoke, canon-guard, workspace-full, registry-integration]
    if: failure()
    steps:
      - uses: actions/checkout@v4
      - name: Collect artifacts
        run: |
          mkdir -p dist-logs
          find . -type f \( -name "*.log" -o -name "last-run.json" -o -path "*/fuzz/artifacts/*" \) \
            -maxdepth 5 -print -exec cp -v {} dist-logs/ \; || true
      - uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: dist-logs
